# Отчёт по инкассации ПВЗ

Сравнение графика инкассации с фактическими данными по франчайзинговым ПВЗ.

## Описание

Скрипт сверяет плановый график инкассации (из Google Sheets через ClickHouse WMS) с фактическими данными о сдаче наличных (из PostgreSQL delivery-point).

## Источники данных

| Источник | База | Таблица | Данные |
|----------|------|---------|--------|
| ClickHouse WMS | bronze | `delivery_db_delivery_point` | Список франчайзи ПВЗ |
| ClickHouse WMS | bronze | `encashment_gsheet` | График инкассации (дни недели) |
| PostgreSQL | delivery-point | `work_shift` | Рабочие смены |
| PostgreSQL | delivery-point | `cash_register_operation` | Операции по кассе (инкассация) |

## Использование

```bash
cd /Users/denis/db_connection_project/encashment
python report.py
```

## Выходные данные

### Статусы инкассации

| Статус | Описание |
|--------|----------|
| Сдал по графику | Инкассация выполнена в запланированный день |
| Не должен был сдавать | День не по графику, инкассации не было |
| Не сдал, а должен был | День по графику, но инкассация не выполнена |
| Сдал не по графику | Инкассация выполнена не в запланированный день |
| НЕТ ГРАФИКА | ПВЗ отсутствует в графике инкассации |

### Выходные файлы

- `encashment_report.html` — интерактивный отчёт (Plotly)
- `encashment_report.png` — статичный график (требует kaleido)

## Графики

1. Круговая диаграмма по статусам
2. Топ-15 ПВЗ по сумме инкассации
3. Причины несдачи (комментарии)
4. Столбчатая диаграмма по статусам

## Функции

| Функция | Описание |
|---------|----------|
| `get_franchise_list()` | Список активных франчайзи из WMS |
| `get_encashment_schedule()` | График инкассации (дни недели) |
| `get_encashment_data()` | Фактические данные по инкассации |
| `build_encashment_report()` | Построение отчёта |
| `print_summary()` | Вывод сводки в консоль |
| `plot_encashment_report()` | Построение графиков |

## Зависимости

- clickhouse_connect
- pandas
- sqlalchemy
- plotly
- kaleido (опционально, для PNG)
