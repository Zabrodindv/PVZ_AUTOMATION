# Отчёт по своевременности открытия ПВЗ

Сравнение расписания работы ПВЗ с фактическим временем открытия смены.

## Описание

Скрипт анализирует своевременность открытия франчайзинговых ПВЗ, сравнивая плановое время открытия (из расписания) с фактическим временем первой смены.

## Источники данных

| Источник | База | Таблица | Данные |
|----------|------|---------|--------|
| ClickHouse WMS | bronze | `delivery_db_delivery_point` | Расписание работы ПВЗ (time_from, time_to) |
| PostgreSQL | delivery-point | `work_shift` | Фактическое время открытия смен |

## Использование

```bash
cd /Users/denis/db_connection_project/late_opening
python report.py
```

### Параметры

```python
build_late_opening_report(
    date_from=None,      # Начало периода (по умолчанию: сегодня)
    date_to=None,        # Конец периода (по умолчанию: завтра)
    deadline_time=None,  # Единый дедлайн для всех ПВЗ
    schedule_time=None   # Фильтр по времени открытия (бакет)
)
```

### Примеры

```python
# Отчёт за сегодня (каждый ПВЗ сравнивается со своим расписанием)
report = build_late_opening_report()

# Отчёт за конкретную дату
report = build_late_opening_report(
    date_from=datetime(2025, 11, 15),
    date_to=datetime(2025, 11, 16)
)

# Только ПВЗ с открытием в 09:00
report = build_late_opening_report(schedule_time="09:00")

# Единый дедлайн 09:40 для всех
report = build_late_opening_report(deadline_time="09:40")
```

## Режимы работы

### Индивидуальное сравнение (по умолчанию)
Каждый ПВЗ сравнивается со своим расписанием (поле `time_from`).

### Бакет (фильтр по времени)
При указании `schedule_time` отбираются только ПВЗ с этим временем открытия.

### Единый дедлайн
При указании `deadline_time` все ПВЗ сравниваются с единым временем.

## Выходные данные

### Метрики

| Метрика | Описание |
|---------|----------|
| total_pvz | Всего ПВЗ в выборке |
| opened_pvz | Открылись (есть смена) |
| late_pvz | Опоздали (открылись позже расписания) |
| on_time_pvz | Вовремя (открылись по расписанию или раньше) |
| not_opened_pvz | Не открылись (нет смены) |

### Статистика опозданий

- Среднее опоздание (минуты)
- Максимальное опоздание
- Медиана
- Распределение по группам (15-30 мин, 30-60 мин, 1-2 часа, >2 часов)

## Функции

| Функция | Описание |
|---------|----------|
| `get_dp_schedule()` | Расписание работы ПВЗ из WMS |
| `get_work_shifts()` | Фактические данные открытия смен |
| `get_schedule_buckets()` | Список уникальных времён открытия |
| `build_late_opening_report()` | Построение отчёта |
| `print_late_opening_report()` | Вывод отчёта в консоль |

## Зависимости

- clickhouse_connect
- pandas
- sqlalchemy
